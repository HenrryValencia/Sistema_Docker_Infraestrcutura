version: '3.8'

services:
  # Nodo 1: macOS (node1) - puede ser bootstrap o réplica según necesidad
  mysql-node1:
    image: mysql:8.0
    container_name: importaciones_db_node1
    environment:
      MYSQL_ROOT_PASSWORD: PasswordSeguro123
      MYSQL_DATABASE: Importaciones_Animales_Valencia
    ports:
      - "3307:3306"
    volumes:
      - mysql-data-node1:/var/lib/mysql
      - ./conf/mysqld.node1.cnf:/etc/mysql/conf.d/mysqld.cnf:ro
      - ./init/01-schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    extra_hosts:
      - "node1:192.168.196.151"
      - "node2:192.168.196.115"
      - "node3:192.168.196.245"
    networks:
      - importaciones-net
    entrypoint: >
      sh -c "
      chown -R mysql:mysql /var/lib/mysql &&
      /usr/local/bin/docker-entrypoint.sh mysqld
      "
    user: root
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1"]
      interval: 10s
      timeout: 5s
      retries: 3
    labels:
      description: "MySQL Nodo 1 (Master) - Ubicación: macOS"

  # Nodo 2: Windows (node2) - réplica/maestro
  mysql-node2:
    image: mysql:8.0
    container_name: importaciones_db_node2
    environment:
      MYSQL_ROOT_PASSWORD: PasswordSeguro123
      MYSQL_DATABASE: Importaciones_Animales_Valencia
    ports:
      - "3308:3306"
    volumes:
      - mysql-data-node2:/var/lib/mysql
      - ./conf/mysqld.node2.cnf:/etc/mysql/conf.d/mysqld.cnf:ro
      - ./init/01-schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    networks:
      - importaciones-net
    entrypoint: >
      sh -c "
      chown -R mysql:mysql /var/lib/mysql &&
      /usr/local/bin/docker-entrypoint.sh mysqld
      "
    user: root
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1"]
      interval: 10s
      timeout: 5s
      retries: 3
    depends_on:
      mysql-node1:
        condition: service_healthy
    labels:
      description: "MySQL Nodo 2 (Master) - Ubicación: Windows"

  # Nodo 3: Ubuntu/Linux (node3) - réplica/maestro
  mysql-node3:
    image: mysql:8.0
    container_name: importaciones_db_node3
    environment:
      MYSQL_ROOT_PASSWORD: PasswordSeguro123
      MYSQL_DATABASE: Importaciones_Animales_Valencia
    ports:
      - "3309:3306"
    volumes:
      - mysql-data-node3:/var/lib/mysql
      - ./conf/mysqld.node3.cnf:/etc/mysql/conf.d/mysqld.cnf:ro
      - ./init/01-schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    networks:
      - importaciones-net
    entrypoint: >
      sh -c "
      chown -R mysql:mysql /var/lib/mysql &&
      /usr/local/bin/docker-entrypoint.sh mysqld
      "
    user: root
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1"]
      interval: 10s
      timeout: 5s
      retries: 3
    depends_on:
      mysql-node1:
        condition: service_healthy
    labels:
      description: "MySQL Nodo 3 (Master) - Ubicación: Ubuntu/Linux"

volumes:
  mysql-data-node1:
    driver: local
  mysql-data-node2:
    driver: local
  mysql-data-node3:
    driver: local

networks:
  importaciones-net:
    driver: bridge
